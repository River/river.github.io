<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>River Jiang</title>
		<script>
			var GITHUB_ISSUES_LINK = "https://api.github.com/repos/river/river.github.io/issues";
			var ME = "river";

			// --- END CONFIG ---

			function isUrl(url) { return /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/.test(url); }

			var keyword = window.location.pathname.split("/")[1];
			// if url ends in "?", display the long url but do not redirect user
			var isQuery = window.location.href.substr(-1) == "?";

			var xhr = new XMLHttpRequest();
			xhr.onload = function () {
				var payload = JSON.parse(xhr.response);
				var issue = "";

				// find issue that matches keyword
				for (var i=0; i<payload.length; i++) {
					if (payload[i].title == keyword) {
						// stop searching after first issue that matches
						issue = payload[i];
						break;
					}
				}
				
				if (issue != "") {
					if (issue.user.login == ME) {
						var url = issue.body;
						if (isUrl(url)){
							document.getElementById("link").innerHTML = "<a href='"+url+"'>"+url+"</a>";
							if (!isQuery) { window.location.replace(url); }
						} else {
							document.getElementById("link").textContent = url;
						}
					} else {
						var url = "Failed authentication (GitHub Issue author is incorrect)"
					}
				} else {
					var url = "Not found";
				}
			}

			// Send XHR request
			xhr.open("GET", GITHUB_ISSUES_LINK);
			xhr.send();
		</script>
	</head>
	<body>
		<h1 id="link">...</h1>
	</body>
</html>
